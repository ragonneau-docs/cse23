%% cse23.tex
%% Copyright 2023 Tom M. Ragonneau
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Tom M. Ragonneau.
\documentclass[
    % nogiturl,  % Whether to include the git URL in the license frame
    % nolicense,  % Whether to include the license frame
]{presentation}

% Resources for the bibliography
\addbibresource{bib/strings.bib}
\addbibresource{bib/optim.bib}
\addbibresource{bib/ragonneau.bib}

% PGF/TikZ support
\usetikzlibrary{patterns}

% Maths commands for this presentation
\newcommand{\obj}{f}
\newcommand{\objm}[1][]{\hat{f}\ifblank{#1}{}{^{#1}}}
\newcommand{\con}{c}
\newcommand{\conm}[1][]{\hat{c}\ifblank{#1}{}{^{#1}}}
\newcommand{\iter}[1][]{x\ifblank{#1}{}{^{#1}}}
\newcommand{\lag}{\mathcal{L}}
\newcommand{\lagm}[1][]{\hat{\mathcal{L}}\ifblank{#1}{}{^{#1}}}
\newcommand{\lm}[1][]{\lambda\ifblank{#1}{}{^{#1}}}
\newcommand{\nstep}[1][]{n\ifblank{#1}{}{^{#1}}}
\newcommand{\rad}[1][]{\Delta\ifblank{#1}{}{^{#1}}}
\newcommand{\step}[1][]{d\ifblank{#1}{}{^{#1}}}
\newcommand{\tstep}[1][]{t\ifblank{#1}{}{^{#1}}}
\newcommand{\xl}{l}
\newcommand{\xu}{u}

% Metadata
\title{COBYQA}
\subtitle{A derivative-free trust-region SQP method for nonlinearly constrained optimization}
\date{CSE23/MS281 (March 2, 2023)}
\author{\href{https://www.tomragonneau.com/}{Tom M. Ragonneau} \and \href{https://www.zhangzk.net/}{Zaikun Zhang}}
\institute{
    Department of Applied Mathematics\\
    The Hong Kong Polytechnic University
}
\titlegraphic{}
\hypersetup{
    pdfsubject={Presentation of COBYQA at CSE23},
    pdfkeywords={COBYQA,optimization,constrained-optimization,nonlinear-optimization,derivative-free optimization,blackbox optimization,trust-region method,SQP framework},
}

\begin{document}

\maketitle

\begin{frame}{General context}
    We design a method for solving the nonlinearly constrained problem
    \begin{align*}
        \min_{\iter \in \R^n}   & \quad \obj(\iter)\\
        \mathrm{s.t.}           & \quad \con(\iter) \le 0,\\
                                & \quad \xl \le \iter \le \xu,
    \end{align*}
    where derivatives of $\obj$ and $\con$ are \alert{unknown}.

    \medskip

    \begin{block}{Notes on the method (COBYQA)}
        \begin{itemize}
            \item COBYQA aims at being a \alert{successor} to COBYLA \parencite{Powell_1994}.
            \item We \alert{implement} COBYQA into a \href{https://pypi.org/project/cobyqa/}{Python solver}.
            \item The equality constraints are omitted for simplicity.
            \item The bound constraints are handled \alert{separately}.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Inviolable bound constraints}
    \begin{block}{The bound constraints $\xl \le \iter \le \xu$ are assumed inviolable}
        \begin{itemize}
            \item They often represent \alert{inalienable} restrictions.
            \item $\obj$ or $\con$ may not be defined otherwise.
        \end{itemize}
    \end{block}

    \medskip

    Therefore, COBYQA \alert{always} respects the bound constraints.

    \medskip

    \begin{block}{A few examples from academia and industry}
        \begin{itemize}
            \item Optimization method tuning \parencite{Audet_Orban_2006}.
            \item Hyperparameter tuning \parencite{Ghanbari_Scheinberg_2017}.
            \item Aircraft engineering \parencite{Gazaix_Etal_2019}.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Table of contents}
    \tableofcontents[hideallsubsections]
\end{frame}

\section{The general framework}

\begin{frame}{The derivative-free trust-region SQP method}

    COBYQA solves iteratively the trust-region SQP subproblem
    \begin{align*}
        \min_{\step \in \R^n}   & \quad \nabla \only<1>{\obj}\only<2>{\alert{\objm[k]}}(\iter[k])^{\T} \step + \frac{1}{2} \step^{\T} \nabla_{x, x}^2 \only<1>{\lag}\only<2>{\alert{\lagm[k]}}(\iter[k], \lm[k]) \step\\
        \textrm{s.t.}           & \quad \only<1>{\con}\only<2>{\alert{\conm[k]}}(\iter[k]) + \nabla \only<1>{\con}\only<2>{\alert{\conm[k]}}(\iter[k]) \step \le 0,\\
                                & \quad \xl \le \iter[k] + \step \le \xu,\\
                                & \quad \norm{\step} \le \rad[k],
    \end{align*}
    with $\only<1>{\lag}\only<2>{\alert{\lagm[k]}}(\iter, \lm) = \only<1>{\obj}\only<2>{\alert{\objm[k]}}(\iter) + \lm^{\T} \only<1>{\con}\only<2>{\alert{\conm[k]}}(\iter)$\only<2>{, given some models $\objm[k]$ and $\conm[k]$}.
    % Details are given in \textcite{Ragonneau_2022}.

    \medskip
    \pause

    \begin{block}{Remarks on the subproblem}
        \begin{itemize}
            \item We only require an approximate solution~$\step[k]$.
            \item The solution must satisfy~$\xl \le \iter[k] + \step[k] \le \xu$.
            \item The subproblem may be \alert{infeasible}; what is a solution?
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{A new \citeauthor{Byrd_1987}-\citeauthor{Omojokun_1989} approach}
    We compute $\step[k] = \nstep[k] + \tstep[k]$, where
    \begin{itemize}
        \item the \alert{normal} step $\nstep[k]$ reduces the (possible) constraint violation, and
        \item the \alert{tangential} step $\tstep[k]$ reduces the quadratic objective function.
    \end{itemize}

    \begin{columns}
        \begin{column}{0.4\textwidth}
            \begin{center}
                \begin{tikzpicture}[scale=0.85]
                    % Linear constraints
                    \uncover<1,2,6->{\fill[color=MidnightBlue,opacity=0.4] (-4,-1) -- (-1.5,-1) -- (-0.5,4) -- (-4,4) -- cycle;}
                    \uncover<3-5>{\fill[color=MidnightBlue,opacity=0.4] (-4,-1) -- (-2.1,-1) -- (-1.1,4) -- (-4,4) -- cycle;}
                    \uncover<1,2,6>{\fill[color=MidnightBlue,opacity=0.4] (-4,1) -- (0,4) -- (-4,4) -- cycle;}
                    \uncover<3-5,7->{\fill[color=MidnightBlue,opacity=0.4] (-4,0.125) -- (1,3.875) -- (1,4) -- (-4,4) -- cycle;}

                    % Trust regions
                    \begin{scope}
                        \clip (-4,-1) rectangle (1,4);
                        \draw[fill=RobRoy,draw opacity=0.7,fill opacity=0.5] (0,0) circle (3);
                        \draw[densely dotted,fill=RobRoy,opacity=0.7] (0,0) circle (2.5);
                    \end{scope}

                    % Feasible region for the tangential subproblem
                    \begin{scope}
                        \clip (-4,0.125) -- (-1.5,2) -- (-1.1,4) -- (-4,4) -- cycle;
                        \uncover<4-5>{\fill[pattern=north west lines,pattern color=VeniceBlue!70!black,opacity=0.8] (0,0) circle (3);}
                    \end{scope}
                    \begin{scope}
                        \clip (-4,0.125) -- (-27/34,43/17) -- (-0.5,4) -- (-4,4) -- cycle;
                        \uncover<8->{\fill[pattern=north west lines,pattern color=VeniceBlue!70!black,opacity=0.8] (0,0) circle (3);}
                    \end{scope}

                    % Frame and annotations
                    \uncover<5>{
                        \draw[-stealth,thick,FernGreen] (-1.5,2) -- (-2.2,1.7);
                        \node[below,xshift=9pt,text=FernGreen] at (-1.85,1.85) {$\tstep[k]$};
                        \draw[-stealth,thick] (0,0) -- (-2.2,1.7);
                        \node[below left] at (-1.1,0.85) {$\step[k]$};
                    }
                    \uncover<9>{
                        \draw[-stealth,thick,FernGreen] (-1.5,2) -- (-0.9,2.7);
                        \node[below,xshift=5pt,text=FernGreen] at (-1.2,2.35) {$\tstep[k]$};
                        \draw[-stealth,thick] (0,0) -- (-0.9,2.7);
                        \node[above right] at (-0.45,1.35) {$\step[k]$};
                    }
                    \uncover<2->{\draw[-stealth,thick,Maroon] (0,0) -- (-1.5,2);}
                    \uncover<2-5>{\node[above right,text=Maroon] at (-0.75,1) {$\nstep[k]$};}
                    \uncover<6->{\node[below left,text=Maroon] at (-0.75,1) {$\nstep[k]$};}
                    \draw[fill] (0,0) circle (1.4pt) node[below right] {$\iter[k]$};
                    \draw[thick] (-4,-1) rectangle (1,4);
                \end{tikzpicture}
            \end{center}
        \end{column}
        \begin{column}{0.6\textwidth}
            \begin{tikzpicture}
                \draw[fill=RobRoy,draw opacity=0.7,fill opacity=0.5] (0,0) circle (.2);
                \node[right] at (.4,0) {Trust region};
                \draw[densely dotted,fill=RobRoy,opacity=0.7] (0,-0.6) circle (.2);
                \node[right] at (.4,-0.6) {Reduced trust region};
                \fill[color=MidnightBlue,opacity=0.4] (-.2,-1.4) rectangle (.2,-1);
                \node[right] at (.4,-1.2) {Linear constraints};
                \uncover<4->{
                    \fill[pattern=north west lines,pattern color=VeniceBlue!70!black,opacity=0.8] (-.2,-2) rectangle (.2,-1.6);
                    \node[right] at (.4,-1.8) {Feasible region for~$\tstep[k]$};
                }
            \end{tikzpicture}

            \bigskip

            The \alert<1-5>{standard} approach\footnote{See \textcite[\S 15.4.4]{Conn_Gould_Toint_2000}.} vs.\ the \alert<6->{new} one.
        \end{column}
    \end{columns}

    \medskip

    \uncover<9>{The feasible region for $\tstep[k]$ is \alert{wider} in the new approach.}
\end{frame}

\begin{frame}{A new \citeauthor{Byrd_1987}-\citeauthor{Omojokun_1989} approach (cont'd)}
    The \alert{\only<1>{standard}\only<2>{new}} approach is as follows.
    \begin{itemize}
        \item The normal step $\nstep[k]$ solves approximately (for some~$\zeta < 1$)
        \begin{align*}
            \min_{\step \in \R^n}   & \quad \norm[\big]{[\conm[k](\iter[k]) + \nabla \conm[k](\iter[k]) \step]^+}\\
            \textrm{s.t.}           & \quad \xl \le \iter[k] + \step \le \xu,\\
                                    & \quad \norm{\step} \le \zeta \rad[k].
        \end{align*}
        \item The tangential step $\tstep[k]$ solves approximately
        \begin{align*}
            \min_{\step \in \R^n}   & \quad \big[ \nabla \objm[k](\iter[k]) + \nabla_{x, x}^2 \lagm[k](\iter[k], \lm[k]) \nstep[k] \big]^{\T} \step + \frac{1}{2} \step^{\T} \nabla_{x, x}^2 \lagm[k](\iter[k], \lm[k]) \step\\
            \text{s.t.}             & \quad \nabla \conm[k](\iter[k])^{\T} \step \le \alert{\only<1>{0}\only<2>{[\conm[k](\iter[k]) + \nabla \conm[k](\iter[k]) \nstep[k]]^-}},\\
                                    & \quad \xl \le \iter[k] + \nstep[k] + \step \le \xu,\\
                                    & \quad \norm{\nstep[k] + \step} \le \rad[k].
        \end{align*}
    \end{itemize}
\end{frame}

\section{Interpolation-based models}

\begin{frame}{Interpolation-based quadratic models}
    \begin{itemize}
        \item Models of \textcite{Powell_2004b}.
        \item Least $H^2$-norm updating models of Xie and Yuan.
    \end{itemize}
\end{frame}

\begin{frame}{Updating the interpolation set}
    To do.
\end{frame}

\section{Gap between theory and practice}

\begin{frame}{A lot of questions must be addressed}
    To do.
\end{frame}

\section{Implementation and experiments}

\begin{frame}{The Python implementation of COBYQA}
    \begin{columns}
        \begin{column}{0.5\textwidth}
            \begin{center}
                \qrcode{https://www.cobyqa.com/}\\[1ex]
                \href{https://www.cobyqa.com/}{Documentation}
            \end{center}
        \end{column}
        \begin{column}{0.5\textwidth}
            \begin{center}
                \qrcode{https://github.com/cobyqa/cobyqa/}\\[1ex]
                \href{https://github.com/cobyqa/cobyqa/}{Source code}
            \end{center}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}{Comparing COBYQA with existing DFO solvers}
    To do.
\end{frame}

\begin{frame}{Performance on bound-constrained problems}
    To do.
\end{frame}

\begin{frame}{Performance on nonlinearly constrained problems}
    To do.
\end{frame}

\begin{frame}{Comparison with COBYLA}
    To do.
\end{frame}

\section{Conclusion}

\begin{frame}{Conclusion and future work}
    To do.
\end{frame}

\appendix

\begin{frame}[t,allowframebreaks]{References}
    \printbibliography[heading=none]
\end{frame}

\end{document}
